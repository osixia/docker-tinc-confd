{{$tinc_confd_run_on_fleet_node_metadata_key := getenv "TINC_CONFD_RUN_ON_FLEET_NODE_METADATA_KEY"}}
{{$tinc_confd_run_on_fleet_node_metadata_value := getenv "TINC_CONFD_RUN_ON_FLEET_NODE_METADATA_VALUE"}}

{{range $machine := lsdir "/_coreos.com/fleet/machines/"}}
{{$machineRawData := getv (print "/_coreos.com/fleet/machines/" $machine "/object")}}
{{$machineData := json $machineRawData}}

{{/* iterate metadata */}}
{{range $machineMetadataKey, $machineMetadataValue := $machineData.Metadata}}

{{if eq $tinc_confd_run_on_fleet_node_metadata_key $machineMetadataKey}}
{{if eq $tinc_confd_run_on_fleet_node_metadata_value $machineMetadataValue}}
{{if exists (print "/_osixia.net/tinc/" $machineData.PublicIP)}}
ConnectTo = {{replace (replace $machineData.PublicIP "." "_" 0) ":" "_" 0}}
{{end}}
{{end}}
{{end}}
{{end}}
{{end}}
