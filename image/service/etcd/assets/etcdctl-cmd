#!/bin/bash -e

ETCD_NODES=""
for node in $(complex-bash-env iterate TINC_ETCD_NODES)
do
  ETCD_NODES="$ETCD_NODES${!node},"
done
ETCD_NODES=${ETCD_NODES::-1}

# etcd certs
TINC_CONFD_CLIENT_CAKEYS=""
if [ -n "${TINC_ETCD_CLIENT_CA_FILENAME}" ]; then
  TINC_CONFD_CLIENT_CAKEYS="--ca-file ${CONTAINER_SERVICE_DIR}/etcd/assets/certs/$TINC_ETCD_CLIENT_CA_FILENAME"
fi

TINC_CONFD_CLIENT_CERT=""
if [ -n "${TINC_ETCD_CLIENT_CERT_FILENAME}" ]; then
  TINC_CONFD_CLIENT_CERT="--cert-file ${CONTAINER_SERVICE_DIR}/etcd/assets/certs/$TINC_ETCD_CLIENT_CERT_FILENAME"
fi

TINC_CONFD_CLIENT_KEY=""
if [ -n "${TINC_ETCD_CLIENT_KEY_FILENAME}" ]; then
  TINC_CONFD_CLIENT_KEY="--key-file ${CONTAINER_SERVICE_DIR}/etcd/assets/certs/$TINC_ETCD_CLIENT_KEY_FILENAME"
fi

exec etcdctl --endpoint $ETCD_NODES $TINC_CONFD_CLIENT_CAKEYS $TINC_CONFD_CLIENT_CERT $TINC_CONFD_CLIENT_KEY "$@"
